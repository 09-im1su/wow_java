# 文件

---

## 逻辑结构

### 无结构文件

- 由二进制流或字符流组成，无明显的逻辑结构 - 如windows中的.txt文件

### 有结构文件

- 由记录组成，分为定长文件、可变长文件 - 如windows中的excel文件
- **逻辑结构**
  - 顺序文件
  - 索引文件
  - 索引顺序文件

### 顺序文件

- 默认各记录在物理上顺序存储
- **串结构**：记录顺序与关键字无关
- **顺序结构**：记录顺序按关键字排序
- 可变长记录的顺序文件无法实现随机存取，定长记录可以
- 定长记录、顺序结构的顺序文件可以快速检索(根据关键字快速找到记录)
- 最大缺点：**不方便增加/删除记录**

### 索引文件

- 建立一张索引表，每个记录对应一个表项。各记录不用保持顺序，方便增加/删除记录
- 索引表本身就是定长记录的顺序文件，一个索引表项就是一条定长记录，因此索引文件可支持随机存取
- 若索引按关键字排序，则可支持快速索引
- 解决了顺序文件不方便增加/删除记录的问题，同时让不定长记录的文件实现了随机存取。但索引表可能占用很多空间

### 索引顺序文件

- 将记录分组，每组对应一个索引表项
- 检索记录时先顺序查询索引表，找到分组，再顺序查找分组
- 当记录过多时，可建立多级索引表

## 文件目录

### 文件目录的实现

- 一个文件对应一个FCB，一个FCB就是一个目录项，多个FCB组成文件目录
- 对目录的操作：搜索、创建文件、删除文件、显示文件、修改文件

### 目录结构

- **单级目录结构**
  - 一个系统只有一张目录表，不允许文件重名
- **两级目录结构**
  - 不同用户的文件可以重名，但不能对文件进行分类
- **多级目录结构 - 树形目录结构**
  - 不同目录下的文件可以重名，可以对文件进行分类，不方便文件共享
  - 系统根据**文件路径**找到目标文件
  - 从根目录出发的路径是**绝对路径**
  - 从当前目录出发的是**相对路径**
- **无环图目录结构**
  - 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图
  - 为共享节点设置一个共享计数器，计数器为0时才真正删除该节点

### 索引节点

- 除了文件名之外的所有信息都放到索引节点中，每个文件对应一个索引节点
- 目录项只包含文件名、索引节点指针，因此每个目录项的长度大幅减小
- 由于目录项长度减小，因此每个磁盘块可以存放更多目录项，因此检索文件时磁盘I/O的次数就少了很多

## 文件物理结构

### 连续分配

- 连续分配方式要求**每个文件在磁盘上占有一组连续的块**
- **特点**
  - 优点：支持顺序访问和直接访问(即随机访问)；连续分配的文件在顺序访问时速度最快
  - 缺点：不方便文件拓展；存储空间利用率低，会产生磁盘碎片

### 链接分配

- 链接分配**采取离散分配的方式，可以为文件分配离散的磁盘块**
- **隐式链接**
  - 除文件的最后一个盘块外，每个盘块中都存有指向下一个盘块的指针
  - 文件目录包括文件第一块的指针和最后一块的指针
  - **特点**
    - 优点：便于文件拓展，不会有碎片问题，外存利用率高
    - 缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要耗费少量的存储空间
- **显式链接**
  - 把用于链接文件各物理块的指针显式地存放在一张表中，即**文件分配表(FAT，File Allocation Table)**
  - 一个磁盘只会建立一张文件分配表
  - 开机时文件分配表被读入内存，且长驻内存
  - **特点**
    - 优点：便于拓展，不会有碎片问题，外存利用率高，并且支持随机访问；相比于隐式链接来说，**地址转换时不需要访问磁盘，因此文件的访问效率更高**
    - 文件分配表需要占用一定的存储空间

### 索引分配

- 索引分配**允许文件离散的分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块**
- 索引表存放的磁盘块称为**索引块**；文件数据存放的磁盘块称为**数据块**
- 若文件太大，索引表项太多，可以采用**链接方案**、**多层索引**、**混合索引**三种方案解决
- **链接方案**
  - 如果索引表太大，一个索引块装不下，则可以将多个索引块链接起来存放
  - 缺点：若文件很大，索引表很长，就需要将很多个索引块链接起来。想要找到 i 号索引块必须先依次读入 0 ~ i-1号索引块，这就导致磁盘I/O次数过多，查找效率低下
- **多层索引**
  - 建立多层索引(类似于多级页表)。采用k层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要 k + 1 次读磁盘操作
  - 缺点：即使是小文件，访问一个数据块依然需要 k + 1 次读磁盘操作
- **混合索引**
  - 多种索引分配方式的结合(直接索引 + 链接索引 + 多层链接索引)
  - 优点：对于小文件，访问一个数据块所需的读磁盘次数更少

## 文件存储空间管理

### 存储空间的划分与初始化

- **文件卷(逻辑卷)**
  - 将物理磁盘划分为一个个的逻辑磁盘(如 C盘、D盘、E盘等...)
- **目录区**
  - 主要存放文件目录信息(FCB)、用于磁盘存储空间管理的信息
- **文件区**
  - 用于存放文件数据
- **初始化**
  - 将各个文件卷划分为目录区与文件区

### 空闲表法

- 空闲表中记录每个连续空闲区的起始盘号、盘块数
- 分配时可采用首次适应、最佳适应、最坏适应等策略
- 回收时需要注意表项的合并问题

### 空闲链表法

- **空闲盘块链**
  - 以盘块为单位组成一条空闲链
  - 分配时从链头依次取出空闲块，回收时将空闲块插到链尾
- **空闲盘区链**
  - 以盘区为单位组成一条空闲链
  - 分配时可采用首次适应、最佳适应等策略
  - 回收时需要注意相邻空闲盘区的合并问题

### 位视图法

- 一个二进制位对应一个盘块 - (字号，位号) 或 (行号，列号)与盘块号一一对应

### 成组链接法

- Unix采用的策略，适合大型文件系统

## 文件基本操作

### 创建文件 - create操作

- 分配外存空间，创建目录项

### 删除文件 - delete操作

- 回收外存空间，删除目录项

### 打开文件 - open操作

- 将目录项中的信息复制到内存中的打开文件表中，并将打开文件表的索引号返回给用户
- 打开文件之后，对文件的操作不再需要每次都查询目录，可以根据内存中的打开文件表进行操作
- **每个进程有自己的打开文件表，系统中也有一张总的打开文件表**
- 进程的打开文件表中特有的属性：读写指针、访问权限
- 系统的打开文件表中特有的属性：打开计数器(记录有多少个进程打开了此文件)

### 关闭文件 - close操作

- 将进程打开文件表中的相应表项删除
- 系统打开文件表的打开计数器减1，若打开计数器为0，则删除系统表的表项

### 读文件 - read操作

- 根据读指针、读入数据量、内存位置将文件数据从外存读入内存

### 写操作 - write操作

- 根据写指针、写入数据量、内存位置将文件数据从内存写出外存

## 文件共享

### 共享与复制

- **共享**
  - 多个用户共享同一个文件，意味着系统中**只有一份文件数据**，只要某个用户修改了该文件的数据，其他用户也可以看到文件数据的变化
- **复制**
  - 如果多个用户都复制了同一个文件，那么系统中**会有好几份文件数据**，其中一个用户修改了自己的那份文件副本，对其他用户的文件数据没有影响

### 基于索引节点的共享方式 - 硬链接

- 各个用户的目录指向同一个索引节点
- 索引节点中需要有链接计数count
- 某用户想删除文件时，只是删除该用户的目录项，且count--
- 只有count == 0时才能真正删除文件数据和索引节点，否则会导致指针悬空

### 基于符号链的共享方式 - 软链接

- 在一个Link型的文件中记录共享文件的存放路径(如windows中的快捷方式)
- 操作系统根据路径一层层查找目录，最终找到共享文件
- 即使软链接指向的共享文件已被删除，Link型文件依然会存在，只是通过Link型文件中的路径去查找共享文件会失败
- 由于用软连接的方式访问共享文件时要查询多级目录，会有多次磁盘I/O，因此软链接访问文件的速度比硬链接要慢

## 文件保护

### 口令保护

- 为文件设置一个**口令**，用户想要访问文件时需要提供口令，由系统验证口令是否正确
- 实现开销小，但**口令**一般存放在FCB或索引节点中(即存放在系统中)，因此不太安全

### 加密保护

- 用一个**密码**对文件加密，用户想要访问文件时，需要提供相同的**密码**才能正确的解密
- 安全性高，但**加密/解密**过程需要耗费一定的时间(如**异或加密**)

### 访问控制

- 用一个访问控制表(ACL)记录各个用户(或各组用户)对文件的访问权限
- 对文件的访问类型可以分为：**读/写/执行/删除等**
- 实现灵活，可以实现复杂的文件保护功能

## 文件系统层次结构

~~~ c
				用户/应用程序
                 |			|
                    用户接口
                 |			|
                  文件目录系统
                 |			|
                  存取控制模块
                 |			|
            逻辑文件系统与文件信息缓冲区
                 |			|
                  物理文件系统
                 |			|
            辅助分配模块 设备管理模块
                    		|
                    	   设备
                   
~~~

### 用户接口

- 文件系统需要向上层的用户提供一些简单易用的功能接口
- 用户接口层就是用于处理用户发出的系统调用请求(Read、Write、Open、Close等系统调用)

### 文件目录系统

- 用户是通过文件目录系统来访问文件的，因此文件目录系统层需要根据用户给出的文件路径找到相应的FCB或索引节点
- 所有的目录、目录相关的管理工作都在文件目录系统层完成。如：管理活跃的文件目录表、管理打开文件表等

### 存取控制模块

- 为了保证文件数据的安全，还需要验证用户是否有访问权限
- 存取控制模块层主要完成了文件保护相关功能

### 逻辑文件系统与文件信息缓冲区

- 用户指明想要访问文件的记录号，该层需要将文件记录号转换为对应的逻辑地址

### 物理文件系统

- 该层需要将上一层提供的文件逻辑地址转换为实际的物理地址

### 辅助分配模块

- 负责文件存储空间的管理，即负责分配和回收存储空间

### 设备管理模块

- 直接与硬件交互，负责和硬件直接相关的一些管理工作。如：分配设备、分配设备缓冲区、磁盘调度、启动设备、释放设备等