# MVCC

---

## MVCC

多版本并发控制。使用MVCC代替锁对并发进行控制，降低性能开销。

## MVCC实现

Innodb中MVCC实现：

- InnoDB的MVCC，是通过在每行记录后面保存两个隐藏的列来实现的。这两个列，分别保存了这个行的创建时间和删除时间。这里存储的并不是实际的时间值，而是系统版本号(可以理解为事务的ID)。每开始一个新的事务，系统版本号就会自动递增，事务开始时刻的系统版本号会作为事务的ID

- INSERT： InnoDB为新插入的每一行保存当前系统版本号作为版本号。 第一个事务ID为1，则创建时间为1，删除时间为undefined；第二个事务ID为2，则创建时间为2，删除时间为undefined

- SELECT：

  - InnoDB会根据以下两个条件检查每行记录：
    - InnoDB只会查找版本早于当前事务版本的数据行(也就是  行的系统版本号小于或等于当前事务的系统版本号)，这样可以确保事务读取的行，要么是在事务开始前已经存在的，要么是事务自身插入或者修改过的
    - 行的删除版本要么未定义，要么大于当前事务版本号。这可以确保事务读取到的行，在事务开始之前未被删除。

  只有同时满足以上两种情况的记录，才能返回作为查询结果

- DELETE：

  -  InnoDB会为删除的每一行保存当前系统的版本号(事务的ID)作为删除标识

- UPDATE：

  -  InnoDB执行UPDATE，实际上是新插入了一行记录，并保存其创建时间为当前事务的ID，同时保存当前事务ID到      要UPDATE的行  的删除时间.

