# InnoDB

---

## Mysql数据库体系结构

- **连接池组件**
- **管理服务和工具组件**
- **SQL接口组件**
- **查询分析器组件**
- **SQL优化器组件**
- **缓冲(cache)组件**
- **插件式存储引擎**
- **物理文件(文件系统与日志文件)**

## InnoDB存储引擎

特点：**完整支持ACID事务**、**行锁设计**、**支持MVCC**、**支持外键**、**提供一致性非锁定读**、**最有效地利用CPU和内存**

### InnoDB体系结构

Innodb存储引擎有多个内存块，可以认为这些内存块组成了一个大的内存池，负责以下工作：

- 维护所有进程/线程需要访问的多个内部数据结构
- 缓存磁盘上的数据，方便快速地读取，同时在对磁盘文件的数据修改之前在内存中缓存
- 重做日志(redo log)缓冲
- ......

Innodb存储引擎包括多个后台线程，主要作用是负责刷新内存池中的数据，保证缓冲池中的内存缓存是最新的数据。此外，将已修改的数据文件刷新到磁盘文件，同时保证在数据库发生异常的情况下Innodb能恢复到正常状态。

#### 后台线程

- **Master Thread**

  Master Thread是一个核心线程，主要负责将缓冲池中的数据异步刷新到磁盘，保证数据的一致性，包括脏页的刷新、合并插入缓冲(INSERT BUFFER)、UNDO页的回收等。

- **IO Thead**

  Innodb存储引擎中使用了大量的AIO(Async IO)来处理读写IO请求，这样可以极大提高数据库的性能。IO Thread主要负责这些IO请求的回调处理。

- **Purge Thread**

  Purge Thread线程主要负责回收已经使用并分配的undo页。

- **Page Cleaner Thread**

  Page Cleaner Thread线程是在Innodb 1.2.x版本中引入的，其作用是将之前版本中脏页的刷新操作都放到单独的线程中来完成，其目的是为减轻原Master Thread线程的工作及对于用户查询线程的阻塞，进一步提高Innodb的性能。

#### 内存

##### 缓冲池

缓冲池简单来说就是一块内存区域，通过内存的速度来弥补磁盘速度较慢对数据库性能的影响。在数据库中进行读取页的操作时，首先将从磁盘读取到的页存放到缓冲池中，这个过程称为将页“FIX”到缓冲池中。下一次读取相同的页时，首先判断该页是否在缓冲池中。若在缓冲池中，称该页在缓冲池中被命中，直接读取该页。否则，读取磁盘上的页。

对于数据库修改页的操作，首先修改在缓冲池中的页，然后再以一定的频率，通过一定的机制(checkpoint)刷新到磁盘上。

缓冲池中缓存的数据页类型有：**索引页**、**数据页**、**undo页**、**插入缓冲(insert buffer)**、**自适应哈希索引(adaptive hash index)**、**InnoDB存储的锁信息(lock info)**、**数据字典信息(data dictionary)**....

- **LRU List**

  通常，数据库中的缓冲池是通过LRU(Lastest Recent Used，最近最少未使用)算法来进行管理的。即最频繁使用的页在LRU列表的前端，最少使用的页在LRU列表的尾端。当缓冲池不能存放新读取到的页时，将首先释放LRU列表中尾端的页。而在InnoDB中，LRU列表中加入了midpoint位置，新读取到的页虽然是最新访问的页，但并不是直接放入LRU列表的首部，而是放入到LRU列表的midpoint位置。默认情况下，该位置在LRU列表长度的5/8处(距尾端37%)。

  **采用midpoint的原因**：若直接将读取到的页放入到LRU的首部，那么某些SQL操作可能会使缓冲池中的页被刷新出，从而影响缓冲池的效率。常见的这类操作有索引或数据的扫描操作。这类操作需要访问表中的许多页，甚至是全部的页，而这些页通常又仅在这次查询操作中需要，并不是活跃的热点数据。如果页被放入LRU列表的首部，那么非常可能将所需要的热点数据页从LRU列表中挤出，而在下一次需要读取热点页时，InnoDB又需要重新访问磁盘。

- **Free List**

  

- **Flush List**

  